{% schema %}
  {
    "name": "BYOB KAVACH",
    "settings": [
      {
        "type": "collection",
        "id": "bundle_collection",
        "label": "Collection for Bundle Products"
      },
      {
        "type": "range",
        "id": "products_per_row_desktop",
        "min": 2,
        "max": 5,
        "step": 1,
        "default": 4,
        "label": "Products per row (Desktop)"
      },
      {
        "type": "range",
        "id": "min_products_for_bundle",
        "min": 2,
        "max": 10,
        "step": 1,
        "default": 2,
        "label": "Minimum products required for bundle"
      },
      {
        "type": "number",
        "id": "tier_1_price",
        "label": "Tier 1 Price (2 products)",
        "default": 799
      },
      {
        "type": "number",
        "id": "tier_2_price",
        "label": "Tier 2 Price (3 products)",
        "default": 1099
      },
      {
        "type": "number",
        "id": "tier_3_price",
        "label": "Tier 3 Price (4 products)",
        "default": 1299
      },
      {
        "type": "text",
        "id": "bundle_heading",
        "default": "Build Your Own Bundle",
        "label": "Section Heading"
      },
      {
        "type": "textarea",
        "id": "bundle_description",
        "default": "Select items to create your custom bundle and save!",
        "label": "Section Description"
      },
      {
        "type": "color",
        "id": "progress_bar_color",
        "default": "#1a73e8",
        "label": "Progress Bar Color"
      },
      {
        "type": "color",
        "id": "button_color",
        "default": "#000000",
        "label": "Button Color"
      }
    ],
    "presets": [
      {
        "name": "BYOB KAVACH",
        "category": "Custom"
      }
    ]
  }
  {% endschema %}
  
  <!-- root colour variable for reuse -->
  <style>
    :root {
      --progress-color: {{ section.settings.progress_bar_color }};
    }
  </style>
  
  <div class="custom-bundle-section" 
       data-min-products="{{ section.settings.min_products_for_bundle }}" 
       data-tier1-price="{{ section.settings.tier_1_price }}"
       data-tier2-price="{{ section.settings.tier_2_price }}"
       data-tier3-price="{{ section.settings.tier_3_price }}">
  
    <!-- New Sticky Header for Desktop -->
    <div class="bundle-progress-header">
      <div class="container">
        <div class="bundle-progress" x-data="{}">
          <div class="bundle-progress__top">
            <!-- <div class="bundle-progress__count">
              <span class="selected-count" style="display: none;">0</span>
              <span class="min-count" style="display: none;">{{ section.settings.min_products_for_bundle }}</span>
              YOUR BUNDLE
            </div> -->
            <div class="tiered-progress-container">
              <div class="tiered-progress">
                <div class="tier tier-1" data-tier="1">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                  </div>
                </div>
                <div class="tier tier-2" data-tier="2">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                  </div>
                </div>
                <div class="tier tier-3" data-tier="3">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                    <span class="optional-badge">OPTIONAL</span>
                    
                  </div>
                </div>
                <div class="tier tier-4" data-tier="4">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                    <span class="optional-badge">OPTIONAL</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="bundle-summary header-bundle-summary">
 
              <button type="button" class="add-bundle-to-cart" disabled>
                <span class="button-text">ADD TO CART</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="section-header text-center">
        <h2>{{ section.settings.bundle_heading }}</h2>
        <div class="bundle-description">{{ section.settings.bundle_description }}</div>
      </div>
      
      <div class="bundle-products-grid">
        {% if section.settings.bundle_collection != blank %}
          {% paginate section.settings.bundle_collection.products by 24 %}
            <div class="products-grid" data-products-per-row="{{ section.settings.products_per_row_desktop }}">
              {% for product in section.settings.bundle_collection.products %}
                <div class="bundle-product-card" 
                     data-product-id="{{ product.id }}" 
                     data-product-price="{{ product.price | divided_by: 100.0 }}"
                     data-product-title="{{ product.title }}"
                     data-product-image="{{ product.featured_image | img_url: '100x100', crop: 'center' }}"
                     data-product-handle="{{ product.handle }}">
                  <div class="bundle-product-card__inner">
                    <div class="bundle-product-card__image">
                      <a href="{{ product.url }}">
                        {% if product.featured_image != blank %}
                          <img src="{{ product.featured_image | img_url: '400x400', crop: 'center' }}" alt="{{ product.featured_image.alt | escape }}">
                        {% else %}
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        {% endif %}
                      </a>
                    </div>
                    <div class="bundle-product-card__info">
                      <h3 class="bundle-product-card__title">
                        <a href="{{ product.url }}">{{ product.title }}</a>
                      </h3>
                      <!-- Judge.me Product Rating -->
                      <div class="product-card__rating">
                        <!-- Start of Judge.me code -->
                        <div
                          style="{{ jm_style }}"
                          class="jdgm-widget jdgm-preview-badge"
                          data-id="{{ product.id }}"
                          data-auto-install="false"
                        >
                          {{ product.metafields.judgeme.badge }}
                        </div>
                        <!-- End of Judge.me code -->
                      </div>
                      <div class="bundle-product-card__price">
                        {{ product.price | money_without_trailing_zeros }}
                        {% if product.compare_at_price > product.price %}
                          <span class="compare-at-price">{{ product.compare_at_price | money_without_trailing_zeros }}</span>
                        {% endif %}
                      </div>
                      <button type="button" class="add-to-bundle-btn" data-product-id="{{ product.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                        <span class="add-text">Add to Box</span>
                        <span class="qty-btn minus" style="display:none;">-</span>
                        <span class="qty-value" style="display:none;">1</span>
                        <span class="qty-btn plus" style="display:none;">+</span>
                      </button>
                    </div>
                    {% if product.metafields.custom.trust_badge != "blank" %}
                    <div class="trust-badges">
                      {% assign badges = product.metafields.custom.trust_badge
                        | remove: '['
                        | remove: ']'
                        | remove: '"'
                        | split: ','
                      %}
                      {% if badges[0] != '' %}
                        <div class="badge">{{ badges[0] | strip }}</div>
                      {% endif %}
                    </div>
                  {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endpaginate %}
        {% else %}
          <div class="empty-collection-message">
            Please select a collection in the section settings.
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="bundle-progress-footer" style="display: none;">
      <div class="container">
        <!-- Progress bar moved to header for desktop -->
        <div class="bundle-progress mobile-only" x-data="{}">
          <div class="bundle-progress__top">
            <div class="bundle-progress__count">
              <span class="selected-count" style="display: none;">0</span>
              <span class="min-count" style="display: none;">{{ section.settings.min_products_for_bundle }}</span>
              YOUR BUNDLE (MIN. 2)
            </div>
            <div class="tiered-progress-container">
              <div class="tiered-progress">
                <div class="tier tier-1" data-tier="1">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                  </div>
                </div>
                <div class="tier tier-2" data-tier="2">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                  </div>
                </div>
                <div class="tier tier-3" data-tier="3">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                  
                  </div>
                </div>
                <div class="tier tier-4" data-tier="4">
                  <div class="tier-progress"></div>
                  <div class="tier-image-container">
                    <img src="" alt="" class="tier-image">
                    <span class="optional-badge">OPTIONAL</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bundle-summary">
          <div class="price-content">
            <div class="price-row">
              <span class="final-price">Price: <span class="bundle-price">₹{{ bundlePrice | round }}</span></span>
              <span class="original-price">₹{{ originalTotal | round }}</span>
            </div>
            <div class="discount-container">
              <span class="discount-tag">Save: ₹{{ savings | round }}</span>
            </div>
          </div>
          <button type="button" class="add-bundle-to-cart" disabled>
            <span class="button-text">ADD TO CART</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    /* --- GENERAL LAYOUT & TYPOGRAPHY ----------------------------------- */
    .custom-bundle-section {
      padding: 4px 4px 120px;
      position: relative;
      background: #fff;
    }
    @media (min-width:786px){ 
       .custom-bundle-section {
      padding: 10px 120px 120px;
    }
    }
    /* .section-header {
      margin-bottom: 30px;
    } */
  
    .bundle-description {
      margin-bottom: 15px;
      font-size: 14px;
    }
  
    /* Tiered discount text container */
    .tiered-discount-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .tier-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      max-width: 200px;
      text-align: center;
    }
    .tier-marker {
      min-width: 12px;
      height: 12px;
      border-radius: 50%;
    }
  .bundle-product-card__inner .trust-badges  {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    position: absolute;
    top: 1px;
    left: 0px;
}
     .bundle-product-card__inner .trust-badges .badge {
    display: inline-block;
    background-image: url(https://cdn.shopify.com/s/files/1/0878/4907/4985/files/Rectangle_46_1.png?v=1747294058);
    background-size: cover;
    background-repeat: no-repeat;
    color: #fff;
    padding: 3px 6px 7px 6px;
    font-size: 0.7rem;
    text-align: left;
}
    /* --- PRODUCT GRID --------------------------------------------------- */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 0 10px;
    }
    @media (max-width:1200px){ 
      .products-grid{ 
        grid-template-columns: repeat(3,1fr);
        padding: 0 15px;
      } 
    }
    @media (max-width:768px){ 
      .products-grid{ 
        grid-template-columns: repeat(2,1fr); 
        gap: 15px;
        padding: 0 10px;
      } 
    }
  
    .bundle-product-card {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background: #fff;
      margin: 0;
    }
    .bundle-product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15);}  
    .bundle-product-card__inner { display:flex; position: relative; flex-direction:column; height:100%; }
    .bundle-product-card__image{ position:relative; overflow:hidden; padding-bottom:100%;}
    .bundle-product-card__image img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transition:transform 0.5s ease; padding:5px;border-radius:10px;}
    .bundle-product-card:hover .bundle-product-card__image img{ transform:scale(1.05);}  
    .bundle-product-card__info{ padding:15px; display:flex; flex-direction:column; flex-grow:1; }
    .bundle-product-card__title{ font-size:14px; font-weight:500; line-height:1.4; }
    .bundle-product-card__title a{ color:#333; text-decoration:none; }
    .jdgm-widget{margin-bottom:10px;font-size:10px;}
    .bundle-product-card__price{ 
      font-size:14px; 
      font-weight:600; 
      margin-bottom:15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .compare-at-price {
      text-decoration: line-through;
      color: #999;
      font-size: 12px;
      font-weight: normal;
    }
  
    .add-to-bundle-btn{ 
      padding:8px 15px; 
      background:#000; 
      color:#fff;
      border:1px solid #000; 
      border-radius:10px; 
      cursor:pointer; 
      font-weight:600; 
      font-size: 14px;
      transition:all 0.3s ease; 
      margin-top:auto; 
    }
    .add-to-bundle-btn:hover{ 
      background:#333; 
      border-color:#333; 
    }
    .add-to-bundle-btn.selected{ 
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      color: #000;
      border-color: #e0e0e0;
      padding: 5px 10px;
      width: 100%;
    }
  
    .qty-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      font-size: 16px;
      line-height: 1;
    }
  
    .qty-btn:hover {
      background: #e0e0e0;
    }
  
    .qty-value {
      flex: 1;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }
  
    /* --- FIXED FOOTER --------------------------------------------------- */
    .bundle-progress-footer{ 
      position:fixed; 
      bottom:0; 
      left:0; 
      width:100%; 
      background:#fff; 
      padding:15px 10px; 
      box-shadow:0 -2px 10px rgba(0,0,0,0.1); 
      z-index:30; 
      transform:translateY(100%); 
      transition:transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }
    .bundle-progress-footer.active{ 
      transform:translateY(0); 
      opacity: 1;
    }  
  
    .bundle-progress__top{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;  }
    .bundle-progress__count{ font-weight:600; font-size:14px; white-space:nowrap; position:relative; }
    .bundle-summary__price{ 
      font-size:14px; 
      word-break:break-word; 
      white-space:normal;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .final-price {
      font-weight: 600;
      font-size: 16px;
      padding: 0px 0px 0px 8px;
    }
    .bundle-price{
      font-size: 16px;
    }
    .original-price, .discount-tag { 
      font-size: 14px; 
      font-weight: 600;
    }
    .original-price {
      text-decoration: line-through;
      color: #999;
    }
    /* .discount-tag {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
      line-height: 1;
      white-space: nowrap;
    } */
  
    /* --- REDESIGNED THIN PROGRESS BAR WITH DOTS ------------------------ */
    .tiered-progress-container {
      flex-grow: 1;
      margin: 0 20px;
      position: relative;
      height: 60px; /* Match image height */
      display: flex;
      align-items: center;
    }
    .tiered-progress {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      height: 4px;
      background: transparent;
      border-radius: 2px;
      z-index: 1;
    }
    .tiered-progress::before {
      content: '';
      position: absolute;
      top: 0 ;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: linear-gradient(to right, #f0f0f0 50%, transparent 50%);
      background-size: 8px 4px;
      z-index: -1;
    }
    .tier {
      flex: 1;
      position: relative;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tier-progress {
      position: absolute;
      inset: 0;
      width: 0%;
      background: transparent;
      transition: width 0.3s ease;
    }
    .tier-progress::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: linear-gradient(to right, var(--progress-color) 50%, transparent 50%);
      background-size: 8px 4px;
      z-index: -1;
    }
    .tier-image-container {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 5%;
      overflow: hidden;
      /* border: 2px solid transparent; */
      outline: 2.5px dashed #c4c4c4;
      background: white;
      transition: border-color 0.3s ease;
      z-index: 2;
    }
    .tier-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .tier-image.active {
      display: block;
    }
    /* .tier.active .tier-image-container {
      border-color: var(--progress-color);
    } */
    .remove-product {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: white;
      color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 3;
      transition: transform 0.2s ease;
    }
    .remove-product:hover {
      transform: scale(1.1);
    }
  
    /* THUMB STRIP AS CAROUSEL */
    .bundle-selected-products{ display:flex; flex-wrap:nowrap; overflow-x:auto; gap:10px; padding:10px 0; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory; }
    .bundle-selected-products::-webkit-scrollbar{ display:none; }
    .selected-product-item{ flex:0 0 60px; height:60px; border-radius:4px; overflow:hidden; position:relative; box-shadow:0 2px 6px rgba(0,0,0,0.1); scroll-snap-align:start; }
    .selected-product-item img{ width:100%; height:100%; object-fit:cover; }
    .remove-product{ position:absolute; top:0; right:0; width:18px; height:18px; background:rgba(255,255,255,0.8); border-radius:0 0 0 4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; color:#333; }
    .remove-product:hover{ background:rgba(255,255,255,0.95); color:#e53935; }
  
    .bundle-summary{ display:flex; justify-content:flex-end; }
    .add-bundle-to-cart {
      padding: 12px 25px;
      border: none;
      border-radius: 4px;
      background: #000;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 50%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      overflow: hidden;
    }
    .add-bundle-to-cart:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .loading-spinner {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
      display: none;
      z-index: 2;
    }
    .loading-spinner svg {
      width: 20px;
      height: 20px;
      position: relative;
      z-index: 2;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .add-bundle-to-cart.is-loading .button-text {
      opacity: 0;
      position: relative;
      z-index: 1;
    }
    .add-bundle-to-cart.is-loading .loading-spinner {
      display: block;
    }
    @media (max-width:992px){
      .bundle-progress__top{ flex-direction:column; align-items:flex-start; }
      .tiered-progress-container{ width:100%; margin:10px 0; }
      .bundle-summary__price{ width:100%; }
    }
    .loading-message {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
      display: none;
    }
    .bundle-summary.is-loading .loading-message {
      display: block;
    }
    .bundle-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }
    .price-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .price-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .discount-container {
      display: flex;
      /* align-items: center; */
    }
    .discount-tag {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
      line-height: 1;
      white-space: nowrap;
    }
    .add-bundle-to-cart {
      padding: 12px 25px;
      border: none;
      border-radius: 4px;
      background: #000;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .optional-badge{
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: grey;
    font-size: 8px;

    padding: 2px 6px;
    border-radius: 3px;
    z-index: 2;
    letter-spacing: 0.5px;
    pointer-events: none;
    }
    .tier-image.active ~ .optional-badge {
    display: none;
  }

  /* New styles for desktop sticky header */
  .bundle-progress-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #fff;
    padding: 30px 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 99;
    transform: translateY(-100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, top 0.3s ease;
    opacity: 0;
    margin-top: 0;
  }

  .bundle-progress-header.active {
    transform: translateY(0);
    opacity: 1;
    top: 0 !important;
  }

  /* Header bundle summary styles */
  .header-bundle-summary {
    margin-left: 20px;
    margin-top: 0;
    flex-shrink: 0;
  }

  @media (min-width: 768px) {
    .bundle-progress-header {
      display: block;
    }

    .bundle-progress-header .bundle-progress__top {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .bundle-progress-header .tiered-progress-container {
      flex: 1;
      margin: 0;
    }

    /* Adjust the container padding */
    .bundle-progress-header .container {
      padding: 0 120px;
    }

    .bundle-progress-footer .bundle-progress {
      display: none;
    }

    .bundle-progress-footer {
      padding: 15px 120px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      z-index: 98;
    }

    .custom-bundle-section {
      padding-bottom: 120px;
    }
  }

  @media (max-width: 767px) {
    .bundle-progress-header {
      display: none;
    }

    .bundle-progress-footer .bundle-progress {
      display: block;
    }
  }

  /* Adjust container padding to prevent content jumping when header becomes sticky */
 @media (min-width: 786px) {
  .custom-bundle-section .container {
    padding-top: 20px;
  }
}

  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const bundleSection = document.querySelector('.custom-bundle-section');
      if (!bundleSection) return;
      
      const minProducts = parseInt(bundleSection.dataset.minProducts);
      const tier1Price = parseFloat(bundleSection.dataset.tier1Price);
      const tier2Price = parseFloat(bundleSection.dataset.tier2Price);
      const tier3Price = parseFloat(bundleSection.dataset.tier3Price);
      
      // Add product restrictions configuration
      const productRestrictions = {
        'selenite-plate': {
          maxQuantity: 1,
          maxInBundle: 1
        }
      };
      
      // Function to check product restrictions
      function checkProductRestrictions(productHandle, currentQuantity = 0) {
        const restriction = productRestrictions[productHandle];
        if (!restriction) return true;
        
        // Check if product is already in bundle
        const existingProduct = selectedProducts.find(p => p.handle === productHandle);
        if (restriction.maxInBundle && existingProduct) {
          return false;
        }
        
        // Check quantity limit
        if (restriction.maxQuantity && currentQuantity >= restriction.maxQuantity) {
          return false;
        }
        
        return true;
      }
      
      const progressFooter = bundleSection.querySelector('.bundle-progress-footer');
      const selectedProductsContainer = bundleSection.querySelector('.bundle-selected-products');
      const progressCount = bundleSection.querySelector('.selected-count');
      const addBundleBtn = bundleSection.querySelector('.add-bundle-to-cart');
      const originalPriceElem = bundleSection.querySelector('.original-price');
      const bundlePriceElem = bundleSection.querySelector('.bundle-price');
      const savingsElem = bundleSection.querySelector('.savings');
      
      // Tier progress elements
      const tierElems = bundleSection.querySelectorAll('.tier');
      
      let selectedProducts = [];
      
      // Activate footer instantly so users see progress
      progressFooter.classList.add('active');
      
      // Product grid interactions (add / remove)
      bundleSection.addEventListener('click', function(e){
        const addBtn = e.target.closest('.add-to-bundle-btn');
        const removeBtn = e.target.closest('.remove-product');
        const plusBtn = e.target.closest('.qty-btn.plus');
        const minusBtn = e.target.closest('.qty-btn.minus');
        
        if(addBtn && !plusBtn && !minusBtn){
          const card = addBtn.closest('.bundle-product-card');
          const productId = addBtn.dataset.productId;
          const variantId = addBtn.dataset.variantId;
          const price = parseFloat(card.dataset.productPrice);
          const title = card.dataset.productTitle;
          const image = card.dataset.productImage;
          const handle = card.dataset.productHandle;
          
          if(addBtn.classList.contains('selected')){
            // This case is now handled by the minus button
          }else{
            // Calculate current total products including quantities
            const currentTotalCount = selectedProducts.reduce((total, p) => total + (p.quantity || 1), 0);
            
            // Check if adding would exceed the maximum limit
            if(currentTotalCount >= 4) {
              alert('You can only add up to 4 products to your bundle.');
              return;
            }

            // Check product restrictions
            if (!checkProductRestrictions(handle)) {
              alert('This product can only be added once to your bundle.');
              return;
            }

            if (typeof clevertap !== 'undefined') {
              clevertap.event.push("BYOB_Added_to_box", {
                "Product Name": title,
                "Product Price": price,
                "Product Handle": handle
              });
            }

            addBtn.classList.add('selected');
            
            // Hide the "Add to Box" text and show quantity controls
            const addText = addBtn.querySelector('.add-text');
            const minusBtn = addBtn.querySelector('.qty-btn.minus');
            const qtyValue = addBtn.querySelector('.qty-value');
            const plusBtn = addBtn.querySelector('.qty-btn.plus');
            
            if (addText) addText.style.display = 'none';
            if (minusBtn) minusBtn.style.display = 'inline-flex';
            if (qtyValue) qtyValue.style.display = 'inline-block';
            if (plusBtn) plusBtn.style.display = 'inline-flex';
            
            // Add product to selected products
            selectedProducts.push({ id: productId, variantId, price, title, image, handle, quantity: 1 });
          }
          updateBundleUI();
        }
        
        // Handle plus button click
        if(plusBtn) {
          const addBtn = plusBtn.closest('.add-to-bundle-btn');
          const productId = addBtn.dataset.productId;
          const card = addBtn.closest('.bundle-product-card');
          const variantId = addBtn.dataset.variantId;
          const price = parseFloat(card.dataset.productPrice);
          const title = card.dataset.productTitle;
          const image = card.dataset.productImage;
          const handle = card.dataset.productHandle;
          const qtyValue = addBtn.querySelector('.qty-value');
          
          // Calculate current total products including quantities
          const currentTotalCount = selectedProducts.reduce((total, p) => total + (p.quantity || 1), 0);
          
          // Check if adding would exceed the maximum limit
          if(currentTotalCount >= 4) {
            alert('You can only add up to 4 products to your bundle.');
            return;
          }
          
          // Find if product already exists in the bundle
          const existingProduct = selectedProducts.find(p => p.id === productId);
          if(existingProduct) {
            // Check product restrictions before increasing quantity
            if (!checkProductRestrictions(handle, existingProduct.quantity)) {
              alert('This product can only be added once to your bundle.');
              return;
            }
            
            // Update quantity display
            existingProduct.quantity = (existingProduct.quantity || 1) + 1;
            qtyValue.textContent = existingProduct.quantity;
          } else {
            // Check product restrictions before adding new product
            if (!checkProductRestrictions(handle)) {
              alert('This product can only be added once to your bundle.');
              return;
            }
            
            // Add new product
            selectedProducts.push({ id: productId, variantId, price, title, image, handle, quantity: 1 });
            qtyValue.textContent = '1';
          }
          
          updateBundleUI();
          e.preventDefault();
          e.stopPropagation();
        }
        
        // Handle minus button click
        if(minusBtn) {
          const addBtn = minusBtn.closest('.add-to-bundle-btn');
          const productId = addBtn.dataset.productId;
          const qtyValue = addBtn.querySelector('.qty-value');
          const addText = addBtn.querySelector('.add-text');
          
          // Find product in the bundle
          const productIndex = selectedProducts.findIndex(p => p.id === productId);
          if(productIndex !== -1) {
            const product = selectedProducts[productIndex];
            
            if(product.quantity > 1) {
              // Decrease quantity
              product.quantity -= 1;
              qtyValue.textContent = product.quantity;
            } else {
              // Remove product if quantity becomes 0
              selectedProducts.splice(productIndex, 1);
              
              // Reset button to original state
              addBtn.classList.remove('selected');
              if (addText) addText.style.display = 'block';
              if (minusBtn) minusBtn.style.display = 'none';
              if (qtyValue) qtyValue.style.display = 'none';
              const plusBtn = addBtn.querySelector('.qty-btn.plus');
              if (plusBtn) plusBtn.style.display = 'none';
            }
            
            updateBundleUI();
          }
          
          e.preventDefault();
          e.stopPropagation();
        }
        
        if(removeBtn){
          const productId = removeBtn.dataset.productId;
          const productDisplayIndex = removeBtn.dataset.productIndex;
          
          // Find the product in the selectedProducts array
          const productIndex = selectedProducts.findIndex(p => p.id === productId);
          if (productIndex !== -1) {
            const product = selectedProducts[productIndex];
            
            // Always decrease quantity by 1 when removing from the progress bar
            if (product.quantity > 1) {
              product.quantity -= 1;
              
              // Update the quantity display in the button
              const gridBtn = bundleSection.querySelector(`.add-to-bundle-btn[data-product-id="${productId}"]`);
              if (gridBtn) {
                const qtyValue = gridBtn.querySelector('.qty-value');
                if (qtyValue) {
                  qtyValue.textContent = product.quantity;
                }
              }
            } else {
              // Remove the product completely if quantity is 1
              selectedProducts.splice(productIndex, 1);
              
              // Reset the button to original state
              const gridBtn = bundleSection.querySelector(`.add-to-bundle-btn[data-product-id="${productId}"]`);
              if(gridBtn){ 
                gridBtn.classList.remove('selected');
                
                // Reset button to original state
                const addText = gridBtn.querySelector('.add-text');
                const minusBtn = gridBtn.querySelector('.qty-btn.minus');
                const qtyValue = gridBtn.querySelector('.qty-value');
                const plusBtn = gridBtn.querySelector('.qty-btn.plus');
                
                if (addText) addText.style.display = 'block';
                if (minusBtn) minusBtn.style.display = 'none';
                if (qtyValue) qtyValue.style.display = 'none';
                if (plusBtn) plusBtn.style.display = 'none';
              }
            }
            updateBundleUI();
          }
        }
      });
      
      // Add bundle to cart
      addBundleBtn.addEventListener('click', function(){
        // Check if we have enough products (using total count including quantities)
        const totalProductCount = selectedProducts.reduce((total, product) => total + (product.quantity || 1), 0);
        if(totalProductCount < 2) return;
        
        // Show loading state
        addBundleBtn.disabled = true;
        addBundleBtn.querySelector('.button-text').textContent = 'ADDING TO CART...';
        
        // Calculate bundle price based on number of products
        let bundlePrice = 0;
        if(totalProductCount >= 4) bundlePrice = tier3Price;
        else if(totalProductCount >= 3) bundlePrice = tier2Price;
        else if(totalProductCount >= 2) bundlePrice = tier1Price;
        
        // Create cart items with the bundle price
        // Instead of mapping directly, we need to create items based on quantities
        const items = [];
        selectedProducts.forEach(product => {
          items.push({
            id: product.variantId,
            quantity: product.quantity || 1,
            properties: {
              'Bundle Price': `₹${bundlePrice}`,
              'Original Price': `₹${selectedProducts.reduce((s,p)=>s+(p.price * (p.quantity || 1)),0)}`,
              'Savings': `₹${selectedProducts.reduce((s,p)=>s+(p.price * (p.quantity || 1)),0) - bundlePrice}`,
              'Kavach_Bundle': true
            }
          });
        });
        
        fetch('/cart/add.js',{
          method:'POST', 
          headers:{
            'Content-Type':'application/json',
            'Accept':'application/json'
          },
          body:JSON.stringify({ items })
        }).then(res=>res.json())
          .then(()=>{ window.location.href='/cart'; })
          .catch(()=>{ window.location.href='/cart'; });
      });
      
      /* ---------- UI UPDATE FUNCTION --------------------------------- */
      function updateBundleUI(){
        // Create expanded products array that includes duplicates based on quantity
        let expandedProducts = [];
        selectedProducts.forEach(product => {
          const quantity = product.quantity || 1;
          for (let i = 0; i < quantity; i++) {
            expandedProducts.push({...product});
          }
        });
        
        // Count total products including quantities
        const totalProductCount = expandedProducts.length;
        const uniqueProductCount = selectedProducts.length;
        
        // Update all count elements
        const countElements = bundleSection.querySelectorAll('.selected-count');
        countElements.forEach(elem => {
          elem.textContent = uniqueProductCount;
        });

        // Update both header and footer progress bars
        const progressHeader = bundleSection.querySelector('.bundle-progress-header');
        const progressFooter = bundleSection.querySelector('.bundle-progress-footer');
        
        // Show/hide progress elements based on count
        if (uniqueProductCount > 0) {
          progressHeader.classList.add('active');
          progressFooter.style.display = 'block';
          progressFooter.classList.add('active');
        } else {
          progressHeader.classList.remove('active');
          progressFooter.classList.remove('active');
          setTimeout(() => {
            progressFooter.style.display = 'none';
          }, 400);
        }

        // Update tier images and progress in both header and footer
        const updateTiers = (container) => {
          const tierImages = container.querySelectorAll('.tier-image');
          const tierContainers = container.querySelectorAll('.tier-image-container');
          const tiers = container.querySelectorAll('.tier');
          
          // Reset all tiers first
          tiers.forEach(tier => {
            tier.classList.remove('active');
            const bar = tier.querySelector('.tier-progress');
            bar.style.width = '0%';
          });

          // Update images and progress using expandedProducts to show duplicates
          expandedProducts.forEach((product, index) => {
            if (index < 4) {
              tierImages[index].src = product.image;
              tierImages[index].alt = product.title;
              tierImages[index].classList.add('active');
              tiers[index].classList.add('active');
              tiers[index].querySelector('.tier-progress').style.width = '100%';
              
              // Add remove button
              const removeBtn = document.createElement('div');
              removeBtn.className = 'remove-product';
              removeBtn.innerHTML = '×';
              removeBtn.dataset.productId = product.id;
              removeBtn.dataset.productIndex = index;
              
              // Remove existing remove buttons
              const existingRemoveBtn = tierContainers[index].querySelector('.remove-product');
              if (existingRemoveBtn) {
                existingRemoveBtn.remove();
              }
              
              tierContainers[index].appendChild(removeBtn);
            }
          });

          // Reset remaining tiers
          for (let i = totalProductCount; i < 4; i++) {
            tierImages[i].src = '';
            tierImages[i].alt = '';
            tierImages[i].classList.remove('active');
            
            const existingRemoveBtn = tierContainers[i].querySelector('.remove-product');
            if (existingRemoveBtn) {
              existingRemoveBtn.remove();
            }
          }
        };

        // Update both header and footer tiers
        updateTiers(progressHeader);
        updateTiers(progressFooter);

        // Update pricing - calculate with quantities
        const originalTotal = selectedProducts.reduce((sum, product) => sum + (product.price * (product.quantity || 1)), 0);
        let bundlePrice = 0;
        
        // Use totalProductCount instead of uniqueProductCount for pricing tiers
        if (totalProductCount === 0) {
          bundlePrice = 0;
        } else if (totalProductCount === 1) {
          bundlePrice = originalTotal;
        } else if (totalProductCount === 2) {
          bundlePrice = tier1Price; // Use tier 1 price for 2 products
        } else if(totalProductCount >= 4){ 
          bundlePrice = tier3Price; 
        } else if(totalProductCount >= 3){ 
          bundlePrice = tier2Price; 
        }
        
        const savings = originalTotal - bundlePrice;
        
        // Update price displays
        bundleSection.querySelector('.bundle-price').textContent = formatRs(bundlePrice);
        bundleSection.querySelector('.original-price').textContent = formatRs(originalTotal);
        bundleSection.querySelector('.discount-tag').textContent = `Save: ${formatRs(savings)}`;

        // Sync both add to cart buttons - use totalProductCount for enabling/disabling
        const addToCartButtons = bundleSection.querySelectorAll('.add-bundle-to-cart');
        addToCartButtons.forEach(button => {
          button.disabled = totalProductCount < 2; // Enable for 2 or more
        });

        // Update both bundle summaries
        const bundleSummaries = bundleSection.querySelectorAll('.bundle-summary');
        bundleSummaries.forEach(summary => {
          summary.querySelector('.bundle-price').textContent = formatRs(bundlePrice);
          summary.querySelector('.original-price').textContent = formatRs(originalTotal);
          summary.querySelector('.discount-tag').textContent = `Save: ${formatRs(savings)}`;
        });
      }
  
      /* ---------- HELPERS ------------------------------------------- */
      function formatRs(num){
        return new Intl.NumberFormat('en-IN',{ style:'currency', currency:'INR', minimumFractionDigits:0 }).format(num);
      }

      function updateStickyHeaderPosition() {
        const header = document.querySelector('.header');
        const announcementBar = document.querySelector('.announcement-bar');
        const bundleProgressHeader = document.querySelector('.bundle-progress-header');
        
        if (header && bundleProgressHeader) {
          let totalHeight = header.offsetHeight;
          if (announcementBar && !announcementBar.hasAttribute('hidden') && window.getComputedStyle(announcementBar).display !== 'none') {
            totalHeight += announcementBar.offsetHeight;
          }
          bundleProgressHeader.style.top = `${totalHeight}px`;
        }
      }

      // Call the function initially
      updateStickyHeaderPosition();

      // Update on resize
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateStickyHeaderPosition, 100);
      });

      // Update when the page is fully loaded
      window.addEventListener('load', updateStickyHeaderPosition);

      // Update periodically for the first few seconds to handle dynamic content
      let updateCount = 0;
      const updateInterval = setInterval(() => {
        updateStickyHeaderPosition();
        updateCount++;
        if (updateCount >= 10) clearInterval(updateInterval);
      }, 500);

      // Observe header height changes
      const headerObserver = new ResizeObserver(updateStickyHeaderPosition);
      const header = document.querySelector('.header');
      if (header) {
        headerObserver.observe(header);
      }

      // Fix for add to cart functionality
      function initializeAddToCartButtons() {
        const addToCartButtons = bundleSection.querySelectorAll('.add-bundle-to-cart');
        
        addToCartButtons.forEach(button => {
          button.addEventListener('click', function() {
            // Check if we have enough products (using total count including quantities)
            const totalProductCount = selectedProducts.reduce((total, product) => total + (product.quantity || 1), 0);
            if (totalProductCount < 2) return;

            // Show loading state
            addToCartButtons.forEach(btn => {
              btn.disabled = true;
              const buttonText = btn.querySelector('.button-text');
              if (buttonText) {
                buttonText.textContent = 'ADDING TO CART...';
              }
            });

            // Calculate bundle price based on number of products
            let bundlePrice = 0;
            if (totalProductCount >= 4) bundlePrice = tier3Price;
            else if (totalProductCount >= 3) bundlePrice = tier2Price;
            else if (totalProductCount >= 2) bundlePrice = tier1Price;

            // Create cart items with the bundle price
            // Instead of mapping directly, we need to create items based on quantities
            const items = [];
            selectedProducts.forEach(product => {
              items.push({
                id: product.variantId,
                quantity: product.quantity || 1,
                properties: {
                  'Bundle Price': `₹${bundlePrice}`,
                  'Original Price': `₹${selectedProducts.reduce((s,p)=>s+(p.price * (p.quantity || 1)),0)}`,
                  'Savings': `₹${selectedProducts.reduce((s,p)=>s+(p.price * (p.quantity || 1)),0) - bundlePrice}`,
                  'Kavach_Bundle': true
                }
              });
            });

            fetch('/cart/add.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ items })
            })
            .then(res => res.json())
            .then(() => {
              window.location.href = '/cart';
            })
            .catch(() => {
              window.location.href = '/cart';
            });
          });
        });
      }

      // Initialize add to cart buttons
      initializeAddToCartButtons();
    });
  </script>
  