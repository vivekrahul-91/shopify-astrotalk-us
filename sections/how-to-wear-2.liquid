{% schema %}
{
  "name": "Collection Product Cards",
  "settings": [
    {
      "type": "text",
      "id": "collection_handle",
      "label": "Collection Handle",
      "default": "frontpage"
    },
    {
      "type": "text",
      "id": "storefront_token",
      "label": "Storefront Access Token (Base64 Reversed)",
      "default": "REPLACE_WITH_YOUR_ENCODED_TOKEN"
    }
  ],
  "presets": [
    {
      "name": "How To Wear",
      "category": "Products"
    }
  ]
}
{% endschema %}

{% style %}
/* Overall Section */
#product-section {
  padding: 15px;
  max-width: 650px;
  margin: 0 auto;
}

/* Search Box */
input#search-box {
  padding: 12px 20px;
  font-size: 13px;
  border: none;
  border-radius: 50px;
  background: #ffffffc2;
  backdrop-filter: blur(10px);
  color: #654321 !important;
  box-shadow: 0 4px 32px rgba(139, 69, 19, 0.1), inset 0px 0px 2px rgba(255, 255, 255, 0.4);
  transition: all 0.3s ease;
  width: 100%;
  margin-bottom: 10px;
}

/* Section Title */
#product-section h2 {
  text-align: left;
  word-spacing: 0;
  margin: 2px;
}

/* Product Card (Collapsed State) */
.product-card {
  display: flex;
  flex-direction: row;
  align-items: center;
  background: #f9f9f9;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  margin: 12px auto;
  width: 360px;
  position: relative;
  transition: all 0.3s ease;
  cursor: pointer;
}

/* Image: fixed at 150x150 with object-fit: contain */
.product-card img {
  width: 30%;
  height: auto;
  padding: 8px 2px 8px 8px;
  background: #fbfaf7;
  border-radius: 18px;
}

/* Product Content */
.product-content {
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  flex-grow: 1;
  overflow: hidden;
  text-align: left;
  width: 100%;
  gap: 3px;
}

.product-content h2 {
  font-size: 0.8rem;
  margin: 0 0 6px;
  font-weight: 600;
  text-align: left;
  text-overflow: ellipsis;
}

/* Collapsed text: truncated to 3 lines */
.product-card:not(.expanded) .product-content p {
  font-size: 0.88rem;
  color: #333;
  margin: 0;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  white-space: normal;
}

/* "View More" button appears only when collapsed */
.view-more-btn {
  background: transparent;
  border: none;
  color: #b8860b;
  font-size: 12px;
  text-decoration: underline;
  cursor: pointer;
  text-underline-offset: 3px;
  font-family: "poppins", sans-serif;
  padding: 0;
  margin-top: 4px;
  align-self: flex-start;
}

/* Expanded Card Layout */
.product-card.expanded {
  flex-direction: column;
  height: auto;
}

.product-card.expanded img {
  width: 100%;
  height: auto;
}

.product-card.expanded .product-content {
  padding: 12px 16px;
  text-align: center;
}

.product-card.expanded .product-content h2 {
  font-size: 1.1rem;
  margin-top: 12px;
  margin-bottom: 10px;
}

.product-card.expanded .product-content p {
  -webkit-line-clamp: unset;
  max-height: none;
  overflow: visible;
  white-space: pre-line;
  text-align: left;
  font-size: 0.92rem;
  line-height: 1.6;
}

/* CTA Buttons Container */
.cta-buttons {
  display: none;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #eee;
}

.product-card.expanded .cta-buttons {
  display: flex;
}

/* CTA Button Styles */
.cta-btn {
  background-color: #000;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 5px 14px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: opacity 0.2s;
  text-decoration: none;
  display: inline-block;
}

.cta-btn:hover {
  opacity: 0.85;
}

.loading {
  text-align: center;
  padding: 20px;
  font-size: 16px;
  color: #666;
}

.error {
  text-align: center;
  padding: 20px;
  font-size: 16px;
  color: #dc2626;
}

.no-products {
  text-align: center;
  padding: 20px;
  font-size: 16px;
  color: #666;
}

/* Mobile Adjustments */
@media (max-width: 768px) {
  .product-card {
    width: 100%;
    max-width: 100%;
    margin: 12px 0;
  }

  .product-content {
    padding: 10px;
  }

  .product-content h2 {
    font-size: 0.95rem;
  }

  .product-card:not(.expanded) .product-content {
    width: 100%;
  }

  .product-card:not(.expanded) .product-content p {
    font-size: 0.85rem;
    -webkit-line-clamp: 3;
  }

  .product-card.expanded .product-content p {
    font-size: 0.88rem;
  }
}

@media (min-width: 769px) {
  .product-card {
    width: 600px;
  }
}
{% endstyle %}

<div id="product-section">
  {% if section.settings.section_title != blank %}
    <h2>{{ section.settings.section_title }}</h2>
  {% endif %}
  
  <!-- Search Input -->
  <input type="text" id="search-box" placeholder="Search products...">
  
  <!-- Products Container -->
  <div id="products-container">
    <div class="loading">Loading products...</div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const collectionHandle = "{{ section.settings.collection_handle }}";
  const encodedToken = "{{ section.settings.storefront_token }}";
  
  // Function to decode the reversed base64 token
  function decodeToken(encoded) {
    try {
      // First reverse the string
      const reversed = encoded.split('').reverse().join('');
      // Then decode from base64
      return atob(reversed);
    } catch (error) {
      console.error('Error decoding token:', error);
      return '';
    }
  }

  const storefrontToken = decodeToken(encodedToken);
  const searchBox = document.getElementById("search-box");
  const productsContainer = document.getElementById("products-container");

  async function fetchAllProducts(handle) {
    const endpoint = '/api/2023-07/graphql.json';
    const url = 'https://' + window.location.hostname + endpoint;

    const query = `
      query getCollectionProducts($handle: String!, $cursor: String) {
        collection(handle: $handle) {
          products(first: 50, after: $cursor) {
            edges {
              cursor
              node {
                id
                title
                handle
                images(first: 1) {
                  edges {
                    node {
                      src
                      altText
                    }
                  }
                }
                metafields(
                  identifiers: [
                    { namespace: "custom", key: "how_to_wear_" }
                  ]
                ) {
                  value
                }
                variants(first: 1) {
                  edges {
                    node {
                      id
                    }
                  }
                }
              }
            }
            pageInfo {
              hasNextPage
            }
          }
        }
      }
    `;

    let allProducts = [];
    let cursor = null;
    let hasNextPage = true;

    try {
      while (hasNextPage) {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Storefront-Access-Token': storefrontToken,
          },
          body: JSON.stringify({
            query,
            variables: {
              handle,
              cursor
            }
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const json = await res.json();

        if (json.errors) {
          console.error('GraphQL Errors:', json.errors);
          throw new Error(json.errors[0].message);
        }

        if (!json.data?.collection) {
          console.error('No collection data returned:', json);
          throw new Error('Collection not found. Please check the collection handle.');
        }

        const edges = json.data.collection.products?.edges || [];
        if (edges.length === 0) {
          console.log('No products found in collection');
          break;
        }

        allProducts.push(...edges.map(edge => edge.node));
        hasNextPage = json.data.collection.products?.pageInfo?.hasNextPage || false;
        cursor = edges.length ? edges[edges.length - 1].cursor : null;
      }

      console.log(`Successfully fetched ${allProducts.length} products`);
      return allProducts;
    } catch (error) {
      console.error('Error fetching products:', error);
      throw error;
    }
  }

  function renderProducts(products) {
    if (!products.length) {
      productsContainer.innerHTML = '<p class="no-products">No products found in this collection.</p>';
      return;
    }

    productsContainer.innerHTML = products.map(product => {
      const image = product.images.edges[0]?.node;
      const howToWear = product.metafields?.[0]?.value || '';
      const variant = product.variants.edges[0]?.node;
      
      return `
        <div class="product-card" data-title="${product.title.toLowerCase()}">
          <img src="${image?.src}" alt="${image?.altText || ''}">
          <div class="product-content">
            <h2>${product.title}</h2>
            <p>${howToWear}</p>
            <button class="view-more-btn">View More</button>
            <div class="cta-buttons">
              <a href="/products/${product.handle}" class="cta-btn more-info-btn">More Info</a>
              <div x-data="xProductCart()">
                <form method="post" action="/cart/add" class="form" enctype="multipart/form-data" novalidate data-type="add-to-cart-form">
                  <input type="hidden" name="form_type" value="product">
                  <input type="hidden" name="utf8" value="âœ“">
                  <input type="hidden" name="id" value="${variant?.id || ''}">
                  <button type="button" class="cta-btn" aria-label="Add to cart" @click="addToCart($event, true)">
                    Add to Cart
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Function to filter products based on search input
  function filterProducts() {
    const query = searchBox.value.toLowerCase();
    const productCards = productsContainer.querySelectorAll('.product-card');
    
    productCards.forEach(card => {
      if (card.dataset.title.includes(query)) {
        card.style.display = "flex";
      } else {
        card.style.display = "none";
      }
    });
  }

  // Attach search functionality to the search box
  searchBox.addEventListener("input", filterProducts);

  // Function to toggle expanded state and update button text
  function toggleCard(card) {
    card.classList.toggle('expanded');
    const btn = card.querySelector('.view-more-btn');
    if (card.classList.contains('expanded')) {
      btn.textContent = "View less";
    } else {
      btn.textContent = "View more";
    }
  }

  // Toggle expanded state on product card click (except when clicking CTA buttons)
  document.addEventListener('click', function(e) {
    const card = e.target.closest('.product-card');
    if (card && !e.target.closest('.cta-buttons') && !e.target.closest('.view-more-btn')) {
      toggleCard(card);
    }
  });

  // "View More" button toggles expanded state and stops propagation
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('view-more-btn')) {
      e.stopPropagation();
      const card = e.target.closest('.product-card');
      toggleCard(card);
    }
  });

  // Load products on page load
  fetchAllProducts(collectionHandle)
    .then(renderProducts)
    .catch(err => {
      console.error('Error fetching products:', err);
      productsContainer.innerHTML = `
        <p class="error">
          Error loading products: ${err.message}<br>
          Please check that:<br>
          1. The collection handle is correct<br>
          2. The Storefront API token is valid<br>
          3. The collection exists and has products
        </p>`;
    });
});
</script>