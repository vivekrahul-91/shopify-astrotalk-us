<link rel="stylesheet" href="{{ 'order-history.css' | asset_url }}" />

<div class="order-history-container">
    <h2 class="order-title">Your Orders</h2>
    {% if customer %}
        {% paginate customer.orders by 5 %}
            {% if customer.orders.size > 0 %}
                {% for order in customer.orders %}
                <div class="order-card" data-order-id="{{ order.name }}">
                    <!-- Order Header -->
                    <div class="order-header">
                        <div class="order-status">
                            <span class="status-label {{ order.fulfillment_status | downcase }}"></span>
                        </div>
                        <div class="order-details">
                            <p><strong>Order Number:</strong><br> {{ order.name }}</p>
                            <p><strong>Order Date:</strong><br> {{ order.created_at | time_tag: format: 'date' }}</p>
                            <p><strong>Payment Method:</strong><br> {{ order.financial_status }} </p>
                            <p><strong>Shipping Address:</strong><br> {{ order.shipping_address.city }}, {{ order.shipping_address.province }}, {{ order.shipping_address.country }}</p>
                        </div>
                        <div class="order-total desk-total">
                            <p><strong>Total Amount:</strong> {{ order.total_price | money }}</p>
                            <div class="order-buttons">
                                <div class="primary-buttons">
                                    <a href="https://astrotalk.store/pages/track-your-order" class="b_track button button-solid o-btn px-5 py-3" target="_blank" data-order-id="{{ order.name }}">Track</a>
                                    {% assign forbidden_statuses = 'fulfilled,delivered,cancelled' | split: ',' %}
                                    {% unless forbidden_statuses contains order.fulfillment_status %}
                                    <button type="button" class="edit-address-btn button button-solid o-btn px-5 py-3" data-order-id="{{ order.id }}" data-order-name="{{ order.name }}" data-address-line1="{{ order.shipping_address.address1 }}" data-city="{{ order.shipping_address.city }}" data-state="{{ order.shipping_address.province }}" data-country="{{ order.shipping_address.country }}" data-pincode="{{ order.shipping_address.zip }}" data-phone="{{ order.shipping_address.phone }}" data-customer-name="{{ order.shipping_address.name }}" data-order-created-at="{{ order.created_at | date: '%s' }}">Edit Address</button>
                                    {% endunless %}
                                </div>
                                <div>
                                    <!-- {% unless settings.hide_cart %}
                                        {% if settings.enable_reorder %}
                                            {%- render 're-order', itemOrder: order -%}
                                        {% endif %}
                                    {% endunless %} -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="order-items" id="order-items">
                        {% for line_item in order.line_items %}
                        <div class="order-item"
                            data-order-id="{{ order.name }}"
                            data-customer-no="{{ order.customer.phone | remove: '+91' }}"
                            data-product-id="{{ line_item.product_id }}"
                            data-variant-id="{{ line_item.variant_id }}"
                            data-product-name="{{ line_item.title }}">
                            <img src="{{ line_item.product.featured_image | img_url: 'medium' }}" alt="{{ line_item.title }}">
                            <div class="item-info" data-product-sku="{{ line_item.sku }}">
                                <div class="info">
                                    <p class="item-title">{{ line_item.title }}</p>
                                    <p><strong>Qty:</strong> {{ line_item.quantity }}</p>
                                    <div class="mob item-price">
                                        <p>{{ line_item.line_price | money }}</p>
                                    </div>
                                    <a href="{{ line_item.product.url }}" class="buy-again">{% render 'eye-icon' %} View product</a>
                                </div>
                                <div class="item-price desk">
                                    <p>{{ line_item.line_price | money }}</p>
                                </div>
                                <!-- Tracking Info Container -->
                                <div class="tracking-info" style="margin-top: 10px; color: #555;">
                                    <p><strong>Tracking Number:</strong> <span class="tracking-number">Loading...</span></p>
                                    <p><strong>Status:</strong> <span class="shipment-status">Loading...</span></p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Mobile Total -->
                    <div class="order-total mob-total">
                        <p><strong>Total Amount:</strong> {{ order.total_price | money }}</p>
                        <div class="order-buttons">
                            <div class="primary-buttons">
                                <a href="https://astrotalk.store/pages/track-your-order" class="b_track button button-solid o-btn px-5 py-3" target="_blank" data-order-id="{{ order.name }}">Track</a>
                                {% unless forbidden_statuses contains order.fulfillment_status %}
                                <button type="button" class="edit-address-btn button button-solid o-btn px-5 py-3" data-order-id="{{ order.id }}" data-order-name="{{ order.name }}" data-address-line1="{{ order.shipping_address.address1 }}" data-city="{{ order.shipping_address.city }}" data-state="{{ order.shipping_address.province }}" data-country="{{ order.shipping_address.country }}" data-pincode="{{ order.shipping_address.zip }}" data-phone="{{ order.shipping_address.phone }}" data-customer-name="{{ order.shipping_address.name }}" data-order-created-at="{{ order.created_at | date: '%s' }}">Edit Address</button>
                                {% endunless %}
                            </div>
                            <div>
                                <button class="b_cancel button button-solid o-btn px-5 py-3 coc-button coc-cancel-button" data-order-id="{{ order.id }}" disabled> Cancel order</button>
                                <script>
                                  document.addEventListener('DOMContentLoaded', function () {
                                    const fulfillmentStatus = "{{ order.fulfillment_status }}"; // Shopify Liquid variable
                                    const orderCreatedAt = "{{ order.created_at | date: '%s' }}"; // UNIX timestamp
                                
                                    const now = Date.now(); // current timestamp in ms
                                    const orderCreatedTime = parseInt(orderCreatedAt) * 1000; // convert seconds to ms
                                
                                    const hoursElapsed = (now - orderCreatedTime) / (1000 * 60 * 60); // in hours
                                
                                    if (fulfillmentStatus === 'unfulfilled' && hoursElapsed < 48) {
                                      document.querySelector('.b_cancel').style.display = 'inline-block';
                                    }
                                      else{
                                      document.querySelector('.b_cancel').style.display = 'none';
                                      }
                                  });
                                </script>
                    
                                <!-- {% unless settings.hide_cart %}
                                    {% if settings.enable_reorder %}
                                        {%- render 're-order', itemOrder: order -%}
                                    {% endif %}
                                {% endunless %} -->
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Pagination -->
                <div class="pagination">
                    {{ paginate | default_pagination }}
                </div>
            {% else %}
                <p>You have no orders yet.</p>
            {% endif %}
        {% endpaginate %}
    {% else %}
        <p>Please <a href="{{ routes.account_login_url }}">log in</a> to view your order history.</p>
    {% endif %}
</div>

<!-- Edit Address Modal (moved here, outside the loop) -->
<div id="edit-address-modal" class="edit-address-modal" style="display:none;">
  <div class="edit-address-modal-content">
    <span class="edit-address-close">&times;</span>
    <h3 class="edit-address-heading">Edit Shipping Address</h3>
    <form id="edit-address-form">
      <input type="hidden" name="order_id" id="edit-order-id">
      <input type="hidden" name="name" id="edit-customer-name">
      <label>Address Line 1:<input type="text" name="addressLine1" id="edit-address-line1" required></label>
      <label>Address Line 2:<input type="text" name="addressLine2" id="edit-address-line2"></label>
      <label>City:<input type="text" name="city" id="edit-city" required></label>
      <label>State:<input type="text" name="state" id="edit-state" required></label>
      <div class="country-pincode-row">
        <label class="country-label">Country:<input type="text" name="country" id="edit-country" required></label>
        <label class="pincode-label">Pincode:<input type="text" name="pincode" id="edit-pincode" required></label>
      </div>
      <label>Phone:<input type="text" name="phone" id="edit-phone" required></label>
      <button type="submit" class="button button-solid o-btn px-5 py-3 edit-address-submit">UPDATE ADDRESS</button>
      <div id="edit-address-message" style="margin-top:10px;"></div>
    </form>
  </div>
</div>

<!-- SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", async function () {
    const orderItems = document.querySelectorAll(".order-item");
    const requestQueue = new Map();
    const POOJA_PRODUCT_ID = "9686086385961";

    // Function to check orders for the pooja product and add video buttons
    function addVideoButtonsToOrders() {
        document.querySelectorAll('.order-card').forEach(orderCard => {
            // Get all product IDs in this order
            const productIds = Array.from(orderCard.querySelectorAll('.order-item'))
                .map(item => item.dataset.productId)
                .filter(id => id); // Remove undefined/empty values
                
            // Check if this order has our target product
            if (productIds.includes(POOJA_PRODUCT_ID)) {
                // Add buttons to desktop view
                const deskButtonsContainer = orderCard.querySelector('.desk-total .primary-buttons');
                if (deskButtonsContainer) {
                    // Create and add Pooja button
                    const poojaBtn = document.createElement('a');
                    poojaBtn.href = 'https://drive.google.com/file/d/10tDTeg04lVNxZVCXC7ciYwAg3UuFXc3n/view?usp=sharing';
                    poojaBtn.className = 'view-pooja-btn button button-solid o-btn px-5 py-3';
                    poojaBtn.target = '_blank';
                    poojaBtn.textContent = 'Pooja Video';
                    deskButtonsContainer.appendChild(poojaBtn);
                    
                    // Create and add Sankalp button
                    const sankalpBtn = document.createElement('a');
                    sankalpBtn.href = 'https://drive.google.com/file/d/1AcapfhJeCDd8R7PEzvcPKSqsRyivf3CV/view?usp=sharing';
                    sankalpBtn.className = 'view-sankalp-btn button button-solid o-btn px-5 py-3';
                    sankalpBtn.target = '_blank';
                    sankalpBtn.textContent = 'Sankalp Video';
                    deskButtonsContainer.appendChild(sankalpBtn);
                }
                
                // Add buttons to mobile view
                const mobButtonsContainer = orderCard.querySelector('.mob-total .primary-buttons');
                if (mobButtonsContainer) {
                    // Create and add Pooja button
                    const poojaBtnMob = document.createElement('a');
                    poojaBtnMob.href = 'https://drive.google.com/file/d/10tDTeg04lVNxZVCXC7ciYwAg3UuFXc3n/view?usp=sharing';
                    poojaBtnMob.className = 'view-pooja-btn button button-solid o-btn px-5 py-3';
                    poojaBtnMob.target = '_blank';
                    poojaBtnMob.textContent = 'Pooja Video';
                    mobButtonsContainer.appendChild(poojaBtnMob);
                    
                    // Create and add Sankalp button
                    const sankalpBtnMob = document.createElement('a');
                    sankalpBtnMob.href = 'https://drive.google.com/file/d/1AcapfhJeCDd8R7PEzvcPKSqsRyivf3CV/view?usp=sharing';
                    sankalpBtnMob.className = 'view-sankalp-btn button button-solid o-btn px-5 py-3';
                    sankalpBtnMob.target = '_blank';
                    sankalpBtnMob.textContent = 'Sankalp Video';
                    mobButtonsContainer.appendChild(sankalpBtnMob);
                }
            }
        });
    }

    async function fetchTrackingData(orderId, customerNo) {
        const cacheKey = `${orderId}-${customerNo}`;
        if (requestQueue.has(cacheKey)) return requestQueue.get(cacheKey);

        const fetchPromise = new Promise(async (resolve) => {
            try {
                const response = await fetch(`https://api.astromall.astrotalk.com/AstroMall/shipment/track-order-data?entityId=${orderId}&mobile=${customerNo}`);
                const data = await response.json();
                resolve(data);
            } catch (error) {
                console.error("Error fetching tracking details:", error);
                resolve(null);
            }
        });

        requestQueue.set(cacheKey, fetchPromise);
        return fetchPromise;
    }

    const groupedByOrder = {};
    orderItems.forEach(item => {
        const orderId = item.dataset.orderId;
        if (!groupedByOrder[orderId]) groupedByOrder[orderId] = [];
        groupedByOrder[orderId].push(item);
    });

    for (const [orderId, items] of Object.entries(groupedByOrder)) {
        const encodedOrderId = encodeURIComponent(orderId);
        const customerNo = encodeURIComponent(items[0].dataset.customerNo);

        const orderCard = items[0].closest(".order-card");
        const orderHeader = orderCard?.querySelector(".order-header");
        const statusLabels = orderCard?.querySelectorAll(".status-label");

        const data = await fetchTrackingData(encodedOrderId, customerNo);

        if (!data || data.status !== "OK" || !data.trackOrderPage?.productDetailList?.length) {
            orderHeader?.classList.remove("has-status");
            continue;
        }

        const trackingList = data.trackOrderPage.productDetailList;
        const trackingNumbers = trackingList.map(d => d.awbNumber);
        const allSameTracking = new Set(trackingNumbers).size === 1;

        if (allSameTracking) {
            const sharedTracking = trackingList[0];
            const number = sharedTracking.awbNumber || "N/A";
            const status = sharedTracking.shipmentStatus;

            items.forEach(item => {
                const trackingNumberElem = item.querySelector(".tracking-number");
                const shipmentStatusElem = item.querySelector(".shipment-status");

                if (trackingNumberElem) trackingNumberElem.innerText = number;
                if (shipmentStatusElem) shipmentStatusElem.innerText = status || "Pending";
            });

            if (status) {
                statusLabels?.forEach(label => {
                    label.innerText = status;
                    label.style.display = "inline-block";
                });
                orderHeader?.classList.add("has-status");
            } else {
                statusLabels?.forEach(label => label.style.display = "none");
                orderHeader?.classList.remove("has-status");
            }
        } else {
            items.forEach((item, i) => {
                const tracking = trackingList[i];
                if (!tracking) return;

                const number = tracking.awbNumber || "N/A";
                const status = tracking.shipmentStatus;

                const trackingNumberElem = item.querySelector(".tracking-number");
                const shipmentStatusElem = item.querySelector(".shipment-status");

                if (trackingNumberElem) trackingNumberElem.innerText = number;
                if (shipmentStatusElem) shipmentStatusElem.innerText = status || "Pending";
            });

            const anyStatus = trackingList.some(item => !!item.shipmentStatus);
            if (anyStatus) {
                statusLabels?.forEach(label => {
                    label.innerText = "Multiple Statuses";
                    label.style.display = "inline-block";
                });
                orderHeader?.classList.add("has-status");
            } else {
                statusLabels?.forEach(label => label.style.display = "none");
                orderHeader?.classList.remove("has-status");
            }
        }
    }
    
    // Add video buttons to orders with pooja product
    addVideoButtonsToOrders();
});

// Edit Address Modal Logic
(function() {
  const modal = document.getElementById('edit-address-modal');
  const closeBtn = modal.querySelector('.edit-address-close');
  const form = document.getElementById('edit-address-form');
  const messageDiv = document.getElementById('edit-address-message');

  function openModal(orderData) {
    document.getElementById('edit-order-id').value = orderData.orderId;
    document.getElementById('edit-customer-name').value = orderData.customerName;
    // Split address1 into two lines if it contains a comma, else leave line2 empty
    var addressParts = (orderData.addressLine1 || '').split(/,\s*/);
    document.getElementById('edit-address-line1').value = addressParts[0] || '';
    document.getElementById('edit-address-line2').value = addressParts.slice(1).join(', ') || '';
    document.getElementById('edit-city').value = orderData.city;
    document.getElementById('edit-state').value = orderData.state;
    document.getElementById('edit-country').value = orderData.country;
    document.getElementById('edit-pincode').value = orderData.pincode;
    document.getElementById('edit-phone').value = orderData.phone;
    messageDiv.textContent = '';
    modal.style.display = 'block';
  }

  function closeModal() {
    modal.style.display = 'none';
  }

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-address-btn')) {
      openModal({
        orderId: e.target.getAttribute('data-order-id'),
        customerName: e.target.getAttribute('data-customer-name'),
        addressLine1: e.target.getAttribute('data-address-line1'),
        city: e.target.getAttribute('data-city'),
        state: e.target.getAttribute('data-state'),
        country: e.target.getAttribute('data-country'),
        pincode: e.target.getAttribute('data-pincode'),
        phone: e.target.getAttribute('data-phone')
      });
    }
  });

  closeBtn.onclick = closeModal;
  window.onclick = function(event) {
    if (event.target == modal) closeModal();
  };

  form.onsubmit = async function(e) {
    e.preventDefault();
    messageDiv.textContent = 'Updating...';
    messageDiv.className = '';
    messageDiv.style.color = '#333';
    const addressLine1 = form.addressLine1.value.trim();
    const addressLine2 = form.addressLine2.value.trim();
    const fullAddressLine1 = addressLine2 ? `${addressLine1}, ${addressLine2}` : addressLine1;
    const payload = {
      order_id: form.order_id.value,
      name: form.name.value,
      addressLine1: fullAddressLine1,
      city: form.city.value,
      state: form.state.value,
      country: form.country.value,
      pincode: form.pincode.value,
      phone: form.phone.value
    };
    try {
      const res = await fetch('https://ozehp0ddk5.execute-api.eu-north-1.amazonaws.com/update-address', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok && data.status === 'success') {
        messageDiv.className = 'success';
        messageDiv.textContent = 'Shipping address changed';
        form.querySelector('.edit-address-submit').style.display = 'none';
        setTimeout(() => {
          closeModal();
          form.querySelector('.edit-address-submit').style.display = '';
          messageDiv.textContent = '';
          messageDiv.className = '';
        }, 1500);
      } else {
        messageDiv.className = 'error';
        messageDiv.textContent = data.message || 'Failed to update address.';
      }
    } catch (err) {
      messageDiv.className = 'error';
      messageDiv.textContent = 'Error updating address.';
    }
  };
})();

// Hide Edit Address buttons if order is older than 30 minutes
(function() {
  var now = Math.floor(Date.now() / 1000);
  document.querySelectorAll('.edit-address-btn').forEach(function(btn) {
    var createdAt = parseInt(btn.getAttribute('data-order-created-at'), 10);
    if (isNaN(createdAt)) return;
    var minutesAgo = (now - createdAt) / 60;
    if (minutesAgo > 30) {
      btn.style.display = 'none';
    }
  });
})();
</script>

<style>
/* Styling for the video buttons */
.view-pooja-btn, .view-sankalp-btn {
    margin-left: 8px;
    color: white;
}

.view-pooja-btn {
    background-color: #ff7e00; /* Orange color for Pooja button */
}

.view-sankalp-btn {
    background-color: #9c27b0; /* Purple color for Sankalp button */
}
.primary-buttons {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    width: 100%;
    gap: 12px;
    text-align: center;
    align-items: self-end;
}
.primary-buttons .o-btn {
    flex: 1 1 0;
    min-width: 0;
    width: 100%;
    height: 44px;
    max-width: 100%;
    border: 1.5px solid black !important;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
}
@media (max-width: 768px) {
    .primary-buttons {
        flex-direction: column;
        gap: 10px;
    }
    .primary-buttons .o-btn {
        width: 100%;
        max-width: 100%;
        height: 44px;
        margin-left: 0 !important;
        margin-top: 0 !important;
    }
    .view-pooja-btn, .view-sankalp-btn {
        margin-top: 8px;
        margin-left: 0;
        display: block;
        width: 100%;
        color: #000;
        max-width: 100%;
    }
}
.o-btn {
    border: 1.5px solid black !important;
    border-radius: 2em;
    font-weight: bold;
    transition: background 0.2s;
    width: 100%;
    height: 44px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
}

.edit-address-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: auto;
  background: rgba(0,0,0,0.4);
}
.edit-address-modal-content {
  background: #fff;
  margin: 5% auto;
  padding: 20px 30px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  position: relative;
}
.edit-address-close {
  position: absolute;
  right: 16px;
  top: 13px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
#edit-address-form label {
  display: block;
  margin: 10px 0 5px;
}
#edit-address-form input {
  width: 100%;
  padding: 6px 8px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
#edit-address-form button {
  width: 100%;
}
#edit-address-message {
  min-height: 20px;
}
.edit-address-btn {
    border: 1px solid black;
    border-radius: 2em;
    font-weight: bold;
    margin-top: 8px;
    transition: background 0.2s;
    width: 100%;
}
.edit-address-heading {
  font-size: 20px;
  padding: 12px 0 18px 0;
  font-weight: bold;
}
.country-pincode-row {
  display: flex;
  gap: 12px;
}
.country-pincode-row label {
  flex: 1 1 0;
  margin-bottom: 0;
}
.edit-address-submit {
  background: #000 !important;
  color: #fff !important;
  text-transform: uppercase;
  font-weight: bold;
  letter-spacing: 1px;
  border: none;
  margin-top: 10px;
}
#edit-address-message.success {
  color: green !important;
}
#edit-address-message.error {
  color: red !important;
}
@media (max-width: 768px) {
  .country-pincode-row {
    flex-direction: column;
    gap: 0;
  }
}
</style>