{% if block.settings.enable_delivery_check %}
    {% assign is_high_value_rudraksha = false %}
    {% if template == 'product.high-value-rudraksha' %}
        {% assign is_high_value_rudraksha = true %}
    {% endif %}
    
    {% assign is_gemstone = false %}
    {% if product.tags contains 'Gem_123' %}
        {% assign is_gemstone = true %}
    {% endif %}
    
    <script>
        const isHighValueRudraksha = {{ is_high_value_rudraksha }};
        const isGemstone = {{ is_gemstone }};
    </script>
    <section class="delivery-check-container">
        <div class="del-heading">
            {% render 'delievery-timer' %}
            <div>
            {% if is_gemstone %}
                <p class="delivery-heading">Most orders are delivered in 7 - 10 days.</p>
            {% elsif is_high_value_rudraksha %}
                <p class="delivery-heading">92% orders are delivered within 7 days</p>
            {% else %}
                <p class="delivery-heading">Get estimated delivery date</p>
            {% endif %}
            <small>Prepaid orders are delivered on priority.</small>
            </div>
        </div>
    <div class="pincode-check">
        <div class="location-icon">
            {% render 'pincode' %}
            {% comment %} {% if block.settings.location_icon %}
            {% else %}
                <img src="https://cdn.shopify.com/s/files/1/0878/4907/4985/files/location.svg" alt="Location" class="icon">
            {% endif %} {% endcomment %}
        </div>
        <input type="text" id="pincode-input" placeholder="Enter your pincode">
        <button id="check-button" onclick="checkDelivery()">Check</button>
    </div>
    <p id="delivery-result" class="delivery-result"></p>
    <p id="delivery-diwali-note" class="delivery-diwali-note" style="display:none"></p>
    <div class="delivery-footer">
        <span class="footer-item">
            <img src="https://cdn.shopify.com/s/files/1/0878/4907/4985/files/free_gift_2.svg?v=1754550412" alt="My SVG Icon" loading="lazy" width="35" height="35">

            {% comment %} {% if block.settings.return_icon %}
                {% render 'gift-icon' %}
            {% else %}
                <img src="https://cdn.shopify.com/s/files/1/0878/4907/4985/files/free_gift.png" alt="Return" class="footer-icon">
            {% endif %} {% endcomment %}
            <span class="footer-text">
                <span class="highlight-text">FREE Gift worth â‚¹499</span><br>
                <span class="sub-text">on all prepaid orders</span>
            </span>
        </span>
        <span class="footer-item">
            <img src="https://cdn.shopify.com/s/files/1/0878/4907/4985/files/delivery_truck.svg?v=1754548842" alt="My SVG Icon" loading="lazy" width="35" height="35">

            {% comment %} {% if block.settings.shipping_icon %}
            {% else %}
                <img src="https://cdn-icons-png.flaticon.com/512/709/709790.png" alt="Free Shipping" class="footer-icon">
            {% endif %} {% endcomment %}
            <span class="footer-text">
                <span class="highlight-text">FREE Shipping</span><br>
                <span class="sub-text">on all orders</span>
            </span>
        </span>
    </div>
</section>

<style>
    .rand-sold-out {
    background: #fffbee;
    border: 1px solid #FFDC75;
    }
.delivery-check-container {
    font-family: "Figtree", sans-serif;
    border: 1px solid #FFDC75;
    padding: 15px;
    border-radius: 8px;
    background: #FFFBEE;
    margin-top: 14px;
    margin-bottom: 20px;
    color: #000;
}

.delivery-heading {
    font-family: "Figtree", sans-serif;
    color: #000;
    font-size: 12px;
    font-style: normal;
    font-weight: 700;
    line-height: normal;
}

.delivery-check-container small {
    font-size: 12px;
    font-weight: 400;
    color: #666;
    display: block;
    line-height: normal;
}

.pincode-check {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 0;
    border: 1px solid grey;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    min-width: 0; /* Prevent flex items from overflowing */
}

.location-icon {
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* Prevent icon from shrinking */
}

.location-icon .icon {
    height: 18px;
    min-width: 16px;
   
}

#pincode-input {
    padding: 10px;
    flex: 1;
    border: none;
    outline: none;
    font-size: 14px;
    min-width: 0; /* Allow input to shrink */
}

.delivery-check-container button {
    padding: 6px 15px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    color: #fff;
    border: none;
    border-radius: 5px;
    background-color: #1A8856;
    margin: 6px;
    flex-shrink: 0; /* Prevent button from shrinking */
    white-space: nowrap; /* Prevent button text from wrapping */
}
.del-heading {
    display: flex;
    gap: 6px;
}
.delivery-check-container button:hover {
        background-color: #1a885685;
}

.delivery-diwali-note {
    margin-top: 4px;
    color: #0f5132; /* dark green */
    font-size: 13px;
    font-weight: 700;
}

#delivery-result {
    margin-top: 0px;
    font-weight: bold;
    padding-top: 7px;
    padding-bottom: 7px;
    padding-left: 10px;
    padding-right: 10px;
    background-color: #f4fceb;
    border-radius: 0 0 6px 6px;
    font-size: 14px;
    display: none;
    color:#59a30e !important;
}

.delivery-footer {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    width: 100%;
}

.footer-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.footer-item:first-child {
    justify-content: flex-start;
}

.footer-item:last-child {
    justify-content: flex-end;
}

.footer-icon {
    
    height: 28px;
    

}

.footer-text {
    font-size: 12px;
    line-height: 1.3;
}

.highlight-text {
    font-weight: bold;
    font-size: 14px;
    color: #000000;
}

.sub-text {
    color: #666;
    font-size: 11px;
}

@media (max-width: 350px) {
    .delivery-footer {
        flex-direction: column;
        gap: 8px;
    }
    
    .footer-item {
        justify-content: center;
    }
    .location-icon .icon {
        min-width: 18px;
        width: 18px;
        height: 18px;
    }
    .delivery-check-container button {
        padding: 3px 6px;
        margin: 4px; /* Reduce margin on very small screens */
        font-size: 12px; /* Slightly smaller font */
    }
    
    .location-icon {
        padding: 6px;
    }
    #pincode-input {
        padding: 6px; /* Reduce padding slightly */
        font-size: 13px; /* Slightly smaller font */
    }
}

/* Additional breakpoint for very narrow screens */
@media (max-width: 320px) {
    .pincode-check {
        flex-wrap: wrap; /* Allow wrapping on extremely narrow screens */
    }
    
    .delivery-check-container button {
        padding: 2px 4px;
        margin: 3px;
        font-size: 11px;
    }
    
    .location-icon {
        padding: 4px;
    }
    
    #pincode-input {
        padding: 4px;
        font-size: 12px;
    }
    
    .location-icon .icon {
        min-width: 16px;
        width: 16px;
        height: 16px;
    }
}
</style>
<script>
// Local storage keys
const STORAGE_KEYS = {
    PINCODE: 'delivery_pincode',
    DELIVERY_TIME: 'delivery_time',
    DELIVERY_DAYS: 'delivery_days',
    TIMESTAMP: 'delivery_timestamp'
};

// Function to save data to local storage
function saveToLocalStorage(key, value) {
    try {
        localStorage.setItem(key, value);
    } catch (error) {
        console.warn('Failed to save to localStorage:', error);
    }
}

// Function to get data from local storage
function getFromLocalStorage(key) {
    try {
        return localStorage.getItem(key);
    } catch (error) {
        console.warn('Failed to read from localStorage:', error);
        return null;
    }
}

// Function to clear local storage data
function clearLocalStorage() {
    try {
        localStorage.removeItem(STORAGE_KEYS.PINCODE);
        localStorage.removeItem(STORAGE_KEYS.DELIVERY_TIME);
        localStorage.removeItem(STORAGE_KEYS.DELIVERY_DAYS);
        localStorage.removeItem(STORAGE_KEYS.TIMESTAMP);
    } catch (error) {
        console.warn('Failed to clear localStorage:', error);
    }
}

// Function to check if cached data is from today
function isCachedDataFromToday(timestamp) {
    if (!timestamp) return false;
    
    const cachedDate = new Date(parseInt(timestamp));
    const today = new Date();
    
    // Compare only the date part (year, month, day)
    return cachedDate.getFullYear() === today.getFullYear() &&
           cachedDate.getMonth() === today.getMonth() &&
           cachedDate.getDate() === today.getDate();
}

// Function to refresh delivery date based on cached data
async function refreshDeliveryDate() {
    const cachedPincode = getFromLocalStorage(STORAGE_KEYS.PINCODE);
    const cachedDeliveryDays = getFromLocalStorage(STORAGE_KEYS.DELIVERY_DAYS);
    
    if (cachedPincode && cachedDeliveryDays) {
        try {
            // Make a new API call to get fresh delivery information
            const response = await fetch('https://kkwts4yfn5.execute-api.eu-north-1.amazonaws.com/check_delivery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ delivery_pincode: cachedPincode })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                const today = new Date();
                let deliveryDays = parseInt(result.estimated_delivery_days || 3);
            if (isHighValueRudraksha) {
                deliveryDays += 7;
            } else {
                // Add 2 extra days to the delivery time (only for non-high-value products)
                deliveryDays += 2;
            }
            // Gemstones need an additional 4 days
            if (isGemstone) {
                deliveryDays += 4;
            }
                today.setDate(today.getDate() + deliveryDays);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                const deliveryMessage = `Free Delivery by ${today.toLocaleDateString('en-US', options)}`;
                
                // Update the display
                const resultElement = document.getElementById('delivery-result');
                resultElement.innerText = deliveryMessage;
                resultElement.style.color = "#28a745";
                resultElement.style.display = "block";
                updateDiwaliNote(today);
                
                // Update localStorage with fresh data
                saveToLocalStorage(STORAGE_KEYS.DELIVERY_TIME, deliveryMessage);
                saveToLocalStorage(STORAGE_KEYS.DELIVERY_DAYS, deliveryDays.toString());
                saveToLocalStorage(STORAGE_KEYS.TIMESTAMP, Date.now().toString());
                
                console.log('Delivery date refreshed automatically');
            }
        } catch (error) {
            console.warn('Failed to refresh delivery date:', error);
            // If refresh fails, we'll keep the old cached data
        }
    }
}

// Function to load cached data on page load
function loadCachedData() {
    const cachedPincode = getFromLocalStorage(STORAGE_KEYS.PINCODE);
    const cachedDeliveryTime = getFromLocalStorage(STORAGE_KEYS.DELIVERY_TIME);
    const cachedTimestamp = getFromLocalStorage(STORAGE_KEYS.TIMESTAMP);
    
    if (cachedPincode && cachedDeliveryTime) {
        // Check if the cached data is from today
        if (isCachedDataFromToday(cachedTimestamp)) {
            // Data is from today, load it normally
            loadCachedDataToForm(cachedPincode, cachedDeliveryTime);
        } else {
            // Data is from a previous day, refresh it automatically
            console.log('Cached data is outdated, refreshing...');
            refreshDeliveryDate();
            // Load the cached data temporarily while refreshing
            loadCachedDataToForm(cachedPincode, cachedDeliveryTime);
        }
    }
}

// Function to load cached data to the form
function loadCachedDataToForm(pincode, deliveryTime) {
    // Fill the pincode input
    const pincodeInput = document.getElementById('pincode-input');
    pincodeInput.value = pincode;
    
    // Show the cached delivery result
    const resultElement = document.getElementById('delivery-result');
    resultElement.innerText = deliveryTime;
    resultElement.style.color = "#28a745";
    resultElement.style.display = "block";
    
    // Change button text to "Change"
    const checkButton = document.getElementById('check-button');
    checkButton.innerText = "Change";
    checkButton.onclick = clearAndReset;
    
    // Disable the input field
    pincodeInput.disabled = true;
}

// Function to clear and reset the form
function clearAndReset() {
    // Clear local storage
    clearLocalStorage();
    
    // Reset the form
    const pincodeInput = document.getElementById('pincode-input');
    const resultElement = document.getElementById('delivery-result');
    const checkButton = document.getElementById('check-button');
    
    pincodeInput.value = '';
    pincodeInput.disabled = false;
    pincodeInput.focus();
    
    resultElement.style.display = 'none';
    const diwaliEl = document.getElementById('delivery-diwali-note');
    if (diwaliEl) diwaliEl.style.display = 'none';
    
    checkButton.innerText = "Check";
    checkButton.onclick = checkDelivery;
}

async function checkDelivery() {
    const pincode = document.getElementById('pincode-input').value.trim();
    const resultElement = document.getElementById('delivery-result');
    
    if (!/^\d{6}$/.test(pincode)) {
        resultElement.innerText = "Please enter a valid 6-digit pincode.";
        resultElement.style.color = "#ff4444";
        resultElement.style.display = "block";
        return;
    }
    
    // Clevertap event push
    if (typeof clevertap !== 'undefined') {
        clevertap.event.push("Delivery_Check_Submitted", {
            "Pincode": pincode,
            "Product Name": window.productName || ""
        });
    }
    
    resultElement.innerText = "Checking...";
    resultElement.style.color = "#666";
    resultElement.style.display = "block";
    
    try {
        const response = await fetch('https://kkwts4yfn5.execute-api.eu-north-1.amazonaws.com/check_delivery', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ delivery_pincode: pincode })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            const today = new Date();
            let deliveryDays = parseInt(result.estimated_delivery_days || 3);
            if (isHighValueRudraksha) {
                deliveryDays += 7;
            } else {
                // Add 2 extra days to the delivery time (only for non-high-value products)
                deliveryDays += 2;
            }
            // Gemstones need an additional 4 days
            if (isGemstone) {
                deliveryDays += 4;
            }
            today.setDate(today.getDate() + deliveryDays);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            const deliveryMessage = `Free Delivery by ${today.toLocaleDateString('en-US', options)}`;
            
            resultElement.innerText = deliveryMessage;
            resultElement.style.color = "#28a745";
            resultElement.style.display = "block";

            // Update Diwali note
            updateDiwaliNote(today);
            
            // Save to local storage
            saveToLocalStorage(STORAGE_KEYS.PINCODE, pincode);
            saveToLocalStorage(STORAGE_KEYS.DELIVERY_TIME, deliveryMessage);
            saveToLocalStorage(STORAGE_KEYS.DELIVERY_DAYS, deliveryDays.toString());
            saveToLocalStorage(STORAGE_KEYS.TIMESTAMP, Date.now().toString());
            
            // Change button text to "Change" and update functionality
            const checkButton = document.getElementById('check-button');
            checkButton.innerText = "Change";
            checkButton.onclick = clearAndReset;
            
            // Disable the input field
            const pincodeInput = document.getElementById('pincode-input');
            pincodeInput.disabled = true;
            
        } else {
            resultElement.innerText = result.message;
            resultElement.style.color = "#ff4444";
            resultElement.style.display = "block";
        }
    } catch (error) {
        resultElement.innerText = "Currently We do not deliver to this location.";
        resultElement.style.color = "#ff4444";
        resultElement.style.display = "block";
    }
}

// Compute and display "Arrives X days before Diwali" under delivery result
function updateDiwaliNote(deliveryDate) {
    try {
        const noteEl = document.getElementById('delivery-diwali-note');
        if (!noteEl) return;
        if (!(deliveryDate instanceof Date) || isNaN(deliveryDate)) {
            noteEl.style.display = 'none';
            return;
        }
        const msPerDay = 24 * 60 * 60 * 1000;
        const diwaliDate = new Date('2025-10-20');
        // Normalize times for consistent diff (ignore hours)
        diwaliDate.setHours(0,0,0,0);
        const d = new Date(deliveryDate.getTime());
        d.setHours(0,0,0,0);
        const diffDays = Math.ceil((diwaliDate - d) / msPerDay);
        if (diffDays === 0) {
            noteEl.textContent = 'Arrives on Diwali';
            noteEl.style.display = 'block';
        } else if (diffDays > 0) {
            noteEl.textContent = `Arrives ${diffDays} day${diffDays === 1 ? '' : 's'} before Diwali`;
            noteEl.style.display = 'block';
        } else {
            noteEl.style.display = 'none';
        }
    } catch (e) {
        // fail silently
    }
}

// Add Enter key support for pincode input
document.addEventListener('DOMContentLoaded', function() {
    const pincodeInput = document.getElementById('pincode-input');
    if (pincodeInput) {
        pincodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkDelivery();
            }
        });
        
        // Load cached data on page load
        loadCachedData();
    }
});
</script>
{% endif %}